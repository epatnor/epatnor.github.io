<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personnummer Konverterare</title>
    <link rel="stylesheet" href="style.css"> <!-- Om du har en extern CSS-fil -->
    <script src="personnummerValidator.js" defer></script> <!-- Ladda den externa JavaScript-filen -->
</head>
<body>
    <h1>Personnummer Konverterare</h1>
    <div id="log"></div>

    <script>
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            let personnummer = urlParams.get('personnummer');

            if (!personnummer) {
                logEntry('Tomt värde', null, false);
                return;
            }

            const originalPersonnummer = personnummer; // Spara för loggning
            const validationResult = validatePersonnummer(personnummer); // Anropa den separata valideringsfunktionen

            if (validationResult.isValid) {
                // Ta bort allt utom siffror
                personnummer = personnummer.replace(/\D/g, ''); // Rensa bort icke-siffror

                // Kontrollera längd och format
                if (personnummer.length === 10) {
                    const yearPrefix = personnummer.substring(0, 2) < "20" ? "20" : "19"; // Bestäm årtalet
                    personnummer = yearPrefix + personnummer; // Lägger till 20 eller 19
                }

                // Kontrollera att personnumret nu är 12 siffror
                if (personnummer.length === 12) {
                    if (isValidControlDigits(personnummer)) {
                        const formateratPersonnummer = personnummer.slice(0, 8) + "-" + personnummer.slice(8); // Format YYYYMMDD-XXXX
                        
                        // Visa det formaterade personnumret på sidan
                        const outputDiv = document.createElement('p');
                        outputDiv.textContent = `Detta personnummer kommer skickas vidare: ${formateratPersonnummer}`;
                        document.body.appendChild(outputDiv);
                    } else {
                        logEntry(originalPersonnummer, null, false, 'Ogiltiga kontrollsiffror.');
                    }
                }
            } else {
                logEntry(originalPersonnummer, null, false, validationResult.errorMessage);
            }

            // Logga händelsen
            logEntry(originalPersonnummer, null, validationResult.isValid);
        };

        function validatePersonnummer(personnummer) {
            // Ta bort allt utom siffror
            personnummer = personnummer.replace(/\D/g, ''); // Rensa bort icke-siffror
            const errorMessage = [];

            // Kontrollera längd
            if (personnummer.length !== 10 && personnummer.length !== 12) {
                return { isValid: false, errorMessage: 'Personnumret måste vara 10 eller 12 siffror.' };
            }

            // Om det är 10 siffror, lägg till årtalsprefix
            if (personnummer.length === 10) {
                const yearPrefix = personnummer.substring(0, 2) < "20" ? "20" : "19";
                personnummer = yearPrefix + personnummer; // Lägger till 20 eller 19
            }

            // Kontrollera giltigt datum
            const year = parseInt(personnummer.slice(0, 4), 10);
            const month = parseInt(personnummer.slice(4, 6), 10);
            const day = parseInt(personnummer.slice(6, 8), 10);

            const date = new Date(year, month - 1, day); // Skapa datumobjekt
            if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) {
                return { isValid: false, errorMessage: 'Ogiltigt datum i personnumret.' };
            }

            return { isValid: true };
        }

        function isValidControlDigits(personnummer) {
            let sum = 0;
            for (let i = 0; i < personnummer.length - 1; i++) { // Exkludera sista siffran
                let digit = parseInt(personnummer[i]);
                if (i % 2 === 1) { // Dubbel varje andra siffra
                    digit *= 2;
                    if (digit > 9) {
                        digit -= 9; // Subtrahera 9 om resultatet är större än 9
                    }
                }
                sum += digit;
            }
            // Kontrollera om summan är delbar med 10
            return (sum + parseInt(personnummer[11])) % 10 === 0; // Inkludera kontrollsiffran
        }

        function logEntry(original, formatted, success, errorMessage = null) {
            const logDiv = document.getElementById('log');
            const logMessage = success
                ? `Framgång: ${original} -> ${formatted}`
                : `Misslyckande: ${original} - ${errorMessage || 'Ogiltigt personnummer'}`;
            logDiv.innerHTML += `<p>${logMessage}</p>`;
        }
    </script>
</body>
</html>
