<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personnummer Konverterare</title>
    <link rel="stylesheet" href="style.css"> <!-- Länka till din CSS-fil -->
    <script src="personnummerValidator.js" defer></script> <!-- Ladda den externa JavaScript-filen -->
</head>
<body>
    <div class="container">
        <h1 class="title">Personnummer Konverterare</h1>
        <button id="themeToggle">Växla tema</button>
        <div id="log" class="log"></div> <!-- Loggfönstret -->
    </div>

    <script>
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            let personnummer = urlParams.get('personnummer');

            if (!personnummer) {
                logEntry('Tomt värde', null, false, 'Personnumret får inte vara tomt.');
                return;
            }

            const originalPersonnummer = personnummer; // Spara för loggning
            const isValid = isValidPersonnummer(personnummer); // Anropa den separata valideringsfunktionen

            if (isValid) {
                // Ta bort allt utom siffror
                personnummer = personnummer.replace(/\D/g, ''); // Rensa bort icke-siffror

                // Kontrollera längd och format
                if (personnummer.length === 10) {
                    personnummer = "19" + personnummer; // Lägger till 19 för 10-siffrigt nummer
                }

                // Kontrollera att personnumret nu är 12 siffror
                if (personnummer.length === 12) {
                    if (isValidControlDigits(personnummer)) {
                        const formateratPersonnummer = personnummer.slice(0, 8) + "-" + personnummer.slice(8); // Format YYYYMMDD-XXXX

                        // Logga det formaterade personnumret i loggfönstret
                        logEntry(originalPersonnummer, formateratPersonnummer, true);
                    } else {
                        logEntry(originalPersonnummer, null, false, 'Ogiltiga kontrollsiffror.');
                    }
                }
            } else {
                logEntry(originalPersonnummer, null, false, 'Ogiltigt personnummer.');
            }
        };

        function isValidControlDigits(personnummer) {
            let sum = 0;
            for (let i = 0; i < personnummer.length - 1; i++) { // Exkludera sista siffran
                let digit = parseInt(personnummer[i]);
                if (i % 2 === 1) { // Dubbel varje andra siffra
                    digit *= 2;
                    if (digit > 9) {
                        digit -= 9; // Subtrahera 9 om resultatet är större än 9
                    }
                }
                sum += digit;
            }
            // Kontrollera om summan är delbar med 10
            return (sum + parseInt(personnummer[11])) % 10 === 0; // Inkludera kontrollsiffran
        }

        function logEntry(original, formatted, success, errorMessage = null) {
            const logDiv = document.getElementById('log');
            const logMessage = success
                ? `<p class="success">Framgång: ${original} -> ${formatted}</p>`
                : `<p class="error">Misslyckande: ${original} - ${errorMessage || 'Ogiltigt personnummer'}</p>`;
            logDiv.innerHTML += logMessage;
        }

        document.getElementById('themeToggle').addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
        });
    </script>
</body>
</html>
